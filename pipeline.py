"""
–ï–¥–∏–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω: URL ‚Üí –ü–∞—Ä—Å–∏–Ω–≥ ‚Üí –ö–æ–Ω—Å–ø–µ–∫—Ç
–ê–Ω–∞–ª–æ–≥ –≤ 1–°: –û–±—â–∏–π –º–æ–¥—É–ª—å, –≤—ã–∑—ã–≤–∞—é—â–∏–π –ø–æ–¥—á–∏–Ω—ë–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python pipeline.py https://habr.com/ru/articles/123456/
    python pipeline.py  # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
"""

import os
import sys
import json
from datetime import datetime

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à–∏ –º–æ–¥—É–ª–∏ (–∫–∞–∫ –≤—ã–∑–æ–≤ –ø—Ä–æ—Ü–µ–¥—É—Ä –∏–∑ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π –≤ 1–°)
from scraper import get_structured_habr_article
from summarizer import generate_summary, save_summary_to_file, read_json_file

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—É—Ç–µ–π
# –ê–Ω–∞–ª–æ–≥ –≤ 1–°: –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã.–ü—É—Ç—å–ö–•—Ä–∞–Ω–∏–ª–∏—â—É–î–∞–Ω–Ω—ã—Ö
DATA_DIR = "data"
PARSED_DIR = os.path.join(DATA_DIR, "parsed_articles")
CONSPECT_DIR = "conspect"


def ensure_directories():
    """
    –°–æ–∑–¥–∞—ë—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–ø–∫–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    –ê–Ω–∞–ª–æ–≥ –≤ 1–°: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å–°–æ–∑–¥–∞—Ç—å–ö–∞—Ç–∞–ª–æ–≥–∏()
    """
    for directory in [DATA_DIR, PARSED_DIR, CONSPECT_DIR]:
        if not os.path.exists(directory):
            os.makedirs(directory)
            print(f"üìÅ –°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞: {directory}")


def generate_filename_from_url(url):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞ –∏–∑ URL —Å—Ç–∞—Ç—å–∏
    –ê–Ω–∞–ª–æ–≥ –≤ 1–°: –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å–ò–º—è–§–∞–π–ª–∞–ò–∑URL()
    
    –ü—Ä–∏–º–µ—Ä: https://habr.com/ru/articles/984968/ ‚Üí habr_984968
    """
    # –ò–∑–≤–ª–µ–∫–∞–µ–º ID —Å—Ç–∞—Ç—å–∏ –∏–∑ URL
    parts = url.rstrip('/').split('/')
    article_id = parts[-1] if parts[-1].isdigit() else "unknown"
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫
    if "habr.com" in url:
        source = "habr"
    else:
        source = "other"
    
    return f"{source}_{article_id}"


def save_parsed_data(article_data, filename):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ JSON (–¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏)
    –ê–Ω–∞–ª–æ–≥ –≤ 1–°: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å–î–∞–Ω–Ω—ã–µ–í–§–∞–π–ª()
    
    :param article_data: —Å–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ —Å—Ç–∞—Ç—å–∏
    :param filename: –∏–º—è —Ñ–∞–π–ª–∞ –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
    :return: –ø—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É
    """
    # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    article_data['parsed_at'] = datetime.now().isoformat()
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å
    file_path = os.path.join(PARSED_DIR, f"{filename}.json")
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º
    with open(file_path, 'w', encoding='utf-8') as f:
        json.dump(article_data, f, ensure_ascii=False, indent=2)
    
    print(f"üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã: {file_path}")
    return file_path


def process_article(url, model="gpt-3.5-turbo", save_json=True):
    """
    –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–∞–π–ø–ª–∞–π–Ω–∞: URL ‚Üí –ö–æ–Ω—Å–ø–µ–∫—Ç
    –ê–Ω–∞–ª–æ–≥ –≤ 1–°: –û–±—Ä–∞–±–æ—Ç–∞—Ç—å–°—Ç–∞—Ç—å—é(URL, –ü–∞—Ä–∞–º–µ—Ç—Ä—ã)
    
    :param url: URL —Å—Ç–∞—Ç—å–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
    :param model: –º–æ–¥–µ–ª—å OpenAI –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    :param save_json: —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ª–∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π JSON
    :return: –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫–æ–Ω—Å–ø–µ–∫—Ç–∞ –∏–ª–∏ None –ø—Ä–∏ –æ—à–∏–±–∫–µ
    """
    print("\n" + "=" * 60)
    print("üöÄ –ó–ê–ü–£–°–ö –ü–ê–ô–ü–õ–ê–ô–ù–ê")
    print("=" * 60)
    
    # –®–ê–ì 1: –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç–∞—Ç—å–∏
    # –ê–Ω–∞–ª–æ–≥ –≤ 1–°: –†–µ–∑—É–ª—å—Ç–∞—Ç–ü–∞—Ä—Å–∏–Ω–≥–∞ = –í—ã–∑–≤–∞—Ç—å–û–±—Ä–∞–±–æ—Ç–∫—É–ü–∞—Ä—Å–µ—Ä–∞(URL)
    print("\nüì• –®–ê–ì 1: –ü–∞—Ä—Å–∏–Ω–≥ —Å—Ç–∞—Ç—å–∏...")
    print("-" * 40)
    
    article_data = get_structured_habr_article(url)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞
    if 'error' in article_data:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: {article_data['error']}")
        return None
    
    print(f"‚úÖ –°—Ç–∞—Ç—å—è —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–∞: {article_data['title']}")
    print(f"   –ê–≤—Ç–æ—Ä: {article_data['author']}")
    print(f"   –î–ª–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞: {article_data['content_length']} —Å–∏–º–≤–æ–ª–æ–≤")
    
    # –®–ê–ì 2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    # –ê–Ω–∞–ª–æ–≥ –≤ 1–°: –ï—Å–ª–∏ –°–æ—Ö—Ä–∞–Ω—è—Ç—å–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ–î–∞–Ω–Ω—ã–µ –¢–æ–≥–¥–∞...
    if save_json:
        filename = generate_filename_from_url(url)
        save_parsed_data(article_data, filename)
    
    # –®–ê–ì 3: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Å–ø–µ–∫—Ç–∞
    # –ê–Ω–∞–ª–æ–≥ –≤ 1–°: –ö–æ–Ω—Å–ø–µ–∫—Ç = –í—ã–∑–≤–∞—Ç—å–û–±—Ä–∞–±–æ—Ç–∫—É–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏(–î–∞–Ω–Ω—ã–µ–°—Ç–∞—Ç—å–∏)
    print(f"\nüß† –®–ê–ì 2: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Å–ø–µ–∫—Ç–∞ (–º–æ–¥–µ–ª—å: {model})...")
    print("-" * 40)
    
    summary = generate_summary(article_data, model)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ—à–∏–±–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    if summary.startswith("‚ùå"):
        print(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {summary}")
        return None
    
    print("‚úÖ –ö–æ–Ω—Å–ø–µ–∫—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!")
    
    # –®–ê–ì 4: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Å–ø–µ–∫—Ç–∞
    # –ê–Ω–∞–ª–æ–≥ –≤ 1–°: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å–ö–æ–Ω—Å–ø–µ–∫—Ç(–ö–æ–Ω—Å–ø–µ–∫—Ç, –ó–∞–≥–æ–ª–æ–≤–æ–∫)
    print(f"\nüíæ –®–ê–ì 3: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–Ω—Å–ø–µ–∫—Ç–∞...")
    print("-" * 40)
    
    article_title = article_data.get('title', '–ë–µ–∑_–Ω–∞–∑–≤–∞–Ω–∏—è')
    saved_path = save_summary_to_file(summary, article_title, CONSPECT_DIR)
    
    # –ò—Ç–æ–≥
    print("\n" + "=" * 60)
    print("‚ú® –ü–ê–ô–ü–õ–ê–ô–ù –ó–ê–í–ï–†–®–Å–ù –£–°–ü–ï–®–ù–û")
    print("=" * 60)
    print(f"üìÑ –ò—Å—Ö–æ–¥–Ω–∞—è —Å—Ç–∞—Ç—å—è: {url}")
    print(f"üìö –ö–æ–Ω—Å–ø–µ–∫—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {saved_path}")
    
    return saved_path


def interactive_mode():
    """
    –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
    –ê–Ω–∞–ª–æ–≥ –≤ 1–°: –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π–†–µ–∂–∏–º()
    """
    print("\n" + "=" * 60)
    print("ü§ñ –ê–ì–ï–ù–¢ –î–õ–Ø –ò–ó–£–ß–ï–ù–ò–Ø –ò–ò ‚Äî –ì–ï–ù–ï–†–ê–¢–û–† –ö–û–ù–°–ü–ï–ö–¢–û–í")
    print("=" * 60)
    
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º URL
    url = input("\nüîó –í–≤–µ–¥–∏—Ç–µ URL —Å—Ç–∞—Ç—å–∏ —Å –•–∞–±—Ä–∞: ").strip()
    
    if not url:
        print("‚ùå URL –Ω–µ —É–∫–∞–∑–∞–Ω. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ.")
        return
    
    # –í–∞–ª–∏–¥–∞—Ü–∏—è URL (–±–∞–∑–æ–≤–∞—è)
    if "habr.com" not in url:
        print("‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: –ü–∞—Ä—Å–µ—Ä –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –•–∞–±—Ä–∞.")
        proceed = input("   –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (y/n): ").strip().lower()
        if proceed not in ['y', 'yes', '–¥–∞']:
            print("–û—Ç–º–µ–Ω–µ–Ω–æ.")
            return
    
    # –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏
    print("\nüìä –í—ã–±–æ—Ä –º–æ–¥–µ–ª–∏:")
    print("   1 ‚Äî gpt-3.5-turbo (–±—ã—Å—Ç—Ä–µ–µ, –¥–µ—à–µ–≤–ª–µ)")
    print("   2 ‚Äî gpt-4 (–∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ, –¥–æ—Ä–æ–∂–µ)")
    
    model_choice = input("   –í–∞—à –≤—ã–±–æ—Ä (Enter = 1): ").strip()
    model = "gpt-4" if model_choice == "2" else "gpt-3.5-turbo"
    
    # –ó–∞–ø—É—Å–∫ –ø–∞–π–ø–ª–∞–π–Ω–∞
    result = process_article(url, model=model)
    
    if result:
        # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        view_choice = input("\nüëÄ –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Å–ø–µ–∫—Ç? (y/n, Enter = –¥–∞): ").strip().lower()
        if view_choice in ['', 'y', 'yes', '–¥–∞']:
            print("\n" + "=" * 60)
            print("üìö –°–û–î–ï–†–ñ–ò–ú–û–ï –ö–û–ù–°–ü–ï–ö–¢–ê:")
            print("=" * 60)
            with open(result, 'r', encoding='utf-8') as f:
                print(f.read())


def main():
    """
    –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ä–µ–∂–∏–º–∞:
    1. –ö–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞: python pipeline.py <URL>
    2. –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π: python pipeline.py
    
    –ê–Ω–∞–ª–æ–≥ –≤ 1–°: –ü—Ä–∏–ó–∞–ø—É—Å–∫–µ()
    """
    # –°–æ–∑–¥–∞—ë–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–ø–∫–∏
    ensure_directories()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    # –ê–Ω–∞–ª–æ–≥ –≤ 1–°: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã–ó–∞–ø—É—Å–∫–∞
    if len(sys.argv) > 1:
        # –†–µ–∂–∏–º –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
        url = sys.argv[1]
        
        # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä –º–æ–¥–µ–ª–∏
        model = sys.argv[2] if len(sys.argv) > 2 else "gpt-3.5-turbo"
        
        process_article(url, model=model)
    else:
        # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
        interactive_mode()


if __name__ == "__main__":
    main()