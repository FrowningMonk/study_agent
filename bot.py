"""
Telegram-–±–æ—Ç –¥–ª—è –∞–≥–µ–Ω—Ç–∞ –∏–∑—É—á–µ–Ω–∏—è –ò–ò
–ê–Ω–∞–ª–æ–≥ –≤ 1–°: HTTP-—Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python bot.py

–ö–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞:
    /start - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
    /help  - –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
    <URL>  - –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–∞—Ç—å—é ‚Üí –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Å–ø–µ–∫—Ç
"""

import os
import telebot
from dotenv import load_dotenv

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—à –ø–∞–π–ø–ª–∞–π–Ω
from pipeline import process_article, ensure_directories

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

# –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
TELEGRAM_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")

if not TELEGRAM_TOKEN:
    print("‚ùå –û—à–∏–±–∫–∞: TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env —Ñ–∞–π–ª–µ!")
    print("   –î–æ–±–∞–≤—å—Ç–µ —Å—Ç—Ä–æ–∫—É: TELEGRAM_BOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω")
    exit(1)

# –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞
bot = telebot.TeleBot(TELEGRAM_TOKEN)

# –°–æ–∑–¥–∞—ë–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–ø–∫–∏
ensure_directories()


# === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ===


@bot.message_handler(commands=['start'])
def handle_start(message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
    """
    user_name = message.from_user.first_name or "–¥—Ä—É–≥"
    
    welcome_text = f"""üëã –ü—Ä–∏–≤–µ—Ç, {user_name}!

–Ø ‚Äî –∞–≥–µ–Ω—Ç –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –ò–ò. –ü–æ–º–æ–≥—É —Å–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç –∏–∑ —Å—Ç–∞—Ç—å–∏.

üîß –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
1. –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–∞—Ç—å—é —Å –•–∞–±—Ä–∞
2. –ü–æ–¥–æ–∂–¥–∏ 30-60 —Å–µ–∫—É–Ω–¥
3. –ü–æ–ª—É—á–∏ –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç!

üìö –ß—Ç–æ —è –∏–∑–≤–ª–µ–∫–∞—é:
‚Ä¢ –û—Å–Ω–æ–≤–Ω—É—é —Ç–µ–º—É
‚Ä¢ –ö–ª—é—á–µ–≤—ã–µ —Ç–µ–∑–∏—Å—ã
‚Ä¢ –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
‚Ä¢ –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –æ–±—Å—É–∂–¥–µ–Ω–∏—è

üí° –ü–æ–ø—Ä–æ–±—É–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!

/help ‚Äî —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º"""

    bot.reply_to(message, welcome_text)


@bot.message_handler(commands=['help'])
def handle_help(message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
    """
    help_text = """üìñ –°–ø—Ä–∞–≤–∫–∞ –ø–æ –±–æ—Ç—É

–ö–æ–º–∞–Ω–¥—ã:
/start ‚Äî –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
/help ‚Äî –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–∞—Ç—å—é, –Ω–∞–ø—Ä–∏–º–µ—Ä:
https://habr.com/ru/articles/984968/

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏:
‚úÖ –•–∞–±—Ä (habr.com)
‚è≥ –î—Ä—É–≥–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ ‚Äî –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:
~30-60 —Å–µ–∫—É–Ω–¥ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–ª–∏–Ω—ã —Å—Ç–∞—Ç—å–∏)

–í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏:
‚Ä¢ –°—Ç–∞—Ç—å—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å —Å—Å—ã–ª–∫—É
‚Ä¢ –¢–∞–π–º–∞—É—Ç ‚Äî –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑
‚Ä¢ –û—à–∏–±–∫–∞ API ‚Äî –ø–æ–¥–æ–∂–¥–∏ –º–∏–Ω—É—Ç—É –∏ –ø–æ–≤—Ç–æ—Ä–∏"""

    bot.reply_to(message, help_text)


@bot.message_handler(func=lambda message: is_url(message.text))
def handle_url(message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
    """
    url = message.text.strip()
    user_id = message.from_user.id
    
    print(f"üì® –ü–æ–ª—É—á–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –æ—Ç {user_id}: {url}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –•–∞–±—Ä
    if "habr.com" not in url:
        bot.reply_to(
            message, 
            "‚ö†Ô∏è –ü–æ–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—å–∏ —Å –•–∞–±—Ä–∞ (habr.com).\n"
            "–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥—Ä—É–≥–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ!"
        )
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å "–ø–µ—á–∞—Ç–∞–µ—Ç..."
    bot.send_chat_action(message.chat.id, 'typing')
    
    # –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    status_msg = bot.reply_to(
        message, 
        "‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é —Å—Ç–∞—Ç—å—é...\n\n"
        "–≠—Ç–æ –∑–∞–π–º—ë—Ç 30-60 —Å–µ–∫—É–Ω–¥."
    )
    
    try:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞–π–ø–ª–∞–π–Ω
        result_path = process_article(url, model="gpt-3.5-turbo", save_json=True)
        
        if result_path is None:
            # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—à–∏–±–∫–æ–π
            bot.edit_message_text(
                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å—Ç–∞—Ç—å—é.\n\n"
                "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
                "‚Ä¢ –°—Ç–∞—Ç—å—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\n"
                "‚Ä¢ –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞\n"
                "‚Ä¢ –ü—Ä–æ–±–ª–µ–º–∞ —Å API\n\n"
                "–ü—Ä–æ–≤–µ—Ä—å —Å—Å—ã–ª–∫—É –∏ –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑.",
                chat_id=message.chat.id,
                message_id=status_msg.message_id
            )
            return
        
        # –ß–∏—Ç–∞–µ–º –≥–æ—Ç–æ–≤—ã–π –∫–æ–Ω—Å–ø–µ–∫—Ç
        with open(result_path, 'r', encoding='utf-8') as f:
            summary = f.read()
        
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        try:
            bot.delete_message(chat_id=message.chat.id, message_id=status_msg.message_id)
        except Exception:
            pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–Ω—Å–ø–µ–∫—Ç –ë–ï–ó Markdown-—Ä–∞–∑–º–µ—Ç–∫–∏ (–Ω–∞–¥—ë–∂–Ω–µ–µ)
        # Telegram –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç 4096 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
        header = "‚úÖ –ö–æ–Ω—Å–ø–µ–∫—Ç –≥–æ—Ç–æ–≤!\n\n"
        
        if len(header) + len(summary) <= 4096:
            bot.send_message(message.chat.id, header + summary)
        else:
            # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏
            bot.send_message(message.chat.id, "‚úÖ –ö–æ–Ω—Å–ø–µ–∫—Ç –≥–æ—Ç–æ–≤!")
            send_long_message(message.chat.id, summary)
        
        print(f"‚úÖ –ö–æ–Ω—Å–ø–µ–∫—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        
    except Exception as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        error_text = f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É."
        
        try:
            bot.edit_message_text(
                error_text,
                chat_id=message.chat.id,
                message_id=status_msg.message_id
            )
        except Exception:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            bot.send_message(message.chat.id, error_text)
        
        print(f"‚ùå –û—à–∏–±–∫–∞ –¥–ª—è {user_id}: {str(e)}")


@bot.message_handler(func=lambda message: True)
def handle_unknown(message):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    """
    bot.reply_to(
        message,
        "ü§î –ù–µ –ø–æ–Ω—è–ª –∫–æ–º–∞–Ω–¥—É.\n\n"
        "–û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç–∞—Ç—å—é —Å –•–∞–±—Ä–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:\n"
        "https://habr.com/ru/articles/984968/\n\n"
        "/help ‚Äî —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º"
    )


# === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===


def is_url(text):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç URL-–∞–¥—Ä–µ—Å–æ–º
    """
    if not text:
        return False
    text = text.strip()
    return text.startswith('http://') or text.startswith('https://')


def send_long_message(chat_id, text, chunk_size=4000):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–ª–∏–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–∞—Å—Ç—è–º–∏
    
    :param chat_id: ID —á–∞—Ç–∞
    :param text: —Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
    :param chunk_size: –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —á–∞—Å—Ç–∏
    """
    # –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –∞–±–∑–∞—Ü–∞–º –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –¥–µ–ª–µ–Ω–∏—è
    paragraphs = text.split('\n\n')
    current_chunk = ""
    
    for paragraph in paragraphs:
        # –ï—Å–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–±–∑–∞—Ü–∞ –ø—Ä–µ–≤—ã—Å–∏—Ç –ª–∏–º–∏—Ç ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π chunk
        if len(current_chunk) + len(paragraph) + 2 > chunk_size:
            if current_chunk:
                bot.send_message(chat_id, current_chunk)
                current_chunk = ""
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∞–±–∑–∞—Ü
        if current_chunk:
            current_chunk += "\n\n" + paragraph
        else:
            current_chunk = paragraph
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫
    if current_chunk:
        bot.send_message(chat_id, current_chunk)


def main():
    """
    –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ ‚Äî –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞
    """
    print("=" * 60)
    print("ü§ñ TELEGRAM-–ë–û–¢ –ê–ì–ï–ù–¢–ê –î–õ–Ø –ò–ó–£–ß–ï–ù–ò–Ø –ò–ò")
    print("=" * 60)
    print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
    print("üì± –ù–∞–π–¥–∏ –±–æ—Ç–∞ –≤ Telegram –∏ –æ—Ç–ø—Ä–∞–≤—å /start")
    print("üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–∂–º–∏ Ctrl+C")
    print("=" * 60)
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
    try:
        bot.infinity_polling(timeout=60, long_polling_timeout=60)
    except KeyboardInterrupt:
        print("\nüëã –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


if __name__ == "__main__":
    main()